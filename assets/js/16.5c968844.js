(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{329:function(a,s,t){"use strict";t.r(s);var e=t(24),r=Object(e.a)({},function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"create-vms-in-openstack"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#create-vms-in-openstack","aria-hidden":"true"}},[a._v("#")]),a._v(" Create VMs in OpenStack")]),a._v(" "),t("div",{staticClass:"tip custom-block"},[t("p",{staticClass:"custom-block-title"},[a._v("TIP")]),a._v(" "),t("p",[a._v("Screencast: "),t("a",{attrs:{href:"https://asciinema.org/a/229605?autoplay=0&t=1",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://asciinema.org/a/229605?t=1"),t("OutboundLink")],1)])]),a._v(" "),t("p",[a._v("Before you start with the main content of the workshop, you need to provision\nthe VMs in OpenStack.")]),a._v(" "),t("p",[a._v("Create VMs in OpenStack using Ubuntu Docker image.")]),a._v(" "),t("h2",{attrs:{id:"prepare-the-local-working-environment-inside-docker"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#prepare-the-local-working-environment-inside-docker","aria-hidden":"true"}},[a._v("#")]),a._v(" Prepare the local working environment inside Docker")]),a._v(" "),t("p",[a._v("Run Ubuntu docker image and mount the directory there:")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" /tmp/test "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cd")]),a._v(" /tmp/test\ndocker run -it -rm -v "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$PWD")]),a._v(":/mnt ubuntu\n")])])]),t("p",[a._v("Install necessary software into the Docker container:")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("apt update -qq\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt-get")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" -y -qq apt-transport-https byobu "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" gnupg jq openssh-client psmisc siege "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" unzip vim "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dev/null\n")])])]),t("p",[a._v("Install "),t("code",[a._v("kubernetes-client")]),a._v(" package:")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" -s https://packages.cloud.google.com/apt/doc/apt-key.gpg "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" apt-key add -\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("echo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"deb https://apt.kubernetes.io/ kubernetes-xenial main"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /etc/apt/sources.list.d/kubernetes.list\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt-get")]),a._v(" update -qq\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt-get")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" -y -qq kubectl\n")])])]),t("p",[a._v("Install "),t("a",{attrs:{href:"https://www.terraform.io/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Terraform"),t("OutboundLink")],1),a._v(":")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("TERRAFORM_LATEST_VERSION"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" -s https://checkpoint-api.hashicorp.com/v1/check/terraform "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq -r -M "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('".current_version"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" --silent --location https://releases.hashicorp.com/terraform/"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${TERRAFORM_LATEST_VERSION}")]),a._v("/terraform_"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${TERRAFORM_LATEST_VERSION}")]),a._v("_linux_amd64.zip --output /tmp/terraform_linux_amd64.zip\nunzip -o /tmp/terraform_linux_amd64.zip -d /usr/local/bin/\n")])])]),t("p",[a._v("Change directory to "),t("code",[a._v("/mnt")]),a._v(" where the git repository is mounted:")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cd")]),a._v(" /mnt\n")])])]),t("h2",{attrs:{id:"provision-vms-in-openstack"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#provision-vms-in-openstack","aria-hidden":"true"}},[a._v("#")]),a._v(" Provision VMs in OpenStack")]),a._v(" "),t("p",[a._v("Start 3 VMs (one master and 2 workers) where the k8s will be installed.")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("Terraform diagram:")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1200/1*lYFNHNM03biX_95IQMayUw.png",alt:"Terraform",title:"Terraform"}}),a._v("\n("),t("a",{attrs:{href:"https://hackernoon.com/terraform-openstack-ansible-d680ea466e22",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://hackernoon.com/terraform-openstack-ansible-d680ea466e22"),t("OutboundLink")],1),a._v(")")])])]),a._v(" "),t("p",[a._v("Generate ssh keys if not exists:")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("test")]),a._v(" -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$HOME")]),a._v("/.ssh/id_rsa "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("||")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" -m 0700 -d "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$HOME")]),a._v("/.ssh "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" ssh-keygen -b 2048 -t rsa -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$HOME")]),a._v("/.ssh/id_rsa -q -N "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('""')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# ssh-agent must be running...")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("test")]),a._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$SSH_AUTH_SOCK")]),a._v('"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("||")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("eval")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),a._v("ssh-agent"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),a._v("ssh-add -l"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v('"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"The agent has no identities."')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v(" ssh-add"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),t("p",[a._v("Clone this git repository:")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" clone https://github.com/ruzickap/k8s-istio-workshop\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cd")]),a._v(" k8s-istio-workshop\n")])])]),t("div",{staticClass:"danger custom-block"},[t("p",{staticClass:"custom-block-title"},[a._v("STOP")]),a._v(" "),t("p",[a._v("Modify the Terraform variable file!")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("OPENSTACK_PASSWORD"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${OPENSTACK_PASSWORD:-default}")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" terrafrom/openstack/terraform.tfvars "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('EOF\nopenstack_auth_url                          = "https://ic-us.ssl.mirantis.net:5000/v3"\nopenstack_instance_flavor_name              = "dev.log"\nopenstack_instance_image_name               = "bionic-server-cloudimg-amd64-20190119"\nopenstack_networking_subnet_dns_nameservers = ["172.19.80.70"]\nopenstack_password                          = "'),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$OPENSTACK_PASSWORD")]),a._v('"\n# drivetrain-team\nopenstack_tenant_name                       = "mirantis-services-team"\nopenstack_user_name                         = "pruzicka"\nopenstack_user_domain_name                  = "ldap_mirantis"\nprefix                                      = "pruzicka-k8s-istio-workshop"\nEOF')]),a._v("\n")])])]),t("p",[a._v("Download Terraform components:")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("terraform init -var-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("terrafrom/openstack/terraform.tfvars terrafrom/openstack\n")])])]),t("p",[a._v("Create VMs in OpenStack:")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("terraform apply -auto-approve -var-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("terrafrom/openstack/terraform.tfvars terrafrom/openstack\n")])])]),t("p",[a._v("Output:")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(".\nvms_name "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("\n    pruzicka-k8s-istio-workshop-node01.01.localdomain,\n    pruzicka-k8s-istio-workshop-node02.01.localdomain,\n    pruzicka-k8s-istio-workshop-node03.01.localdomain\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\nvms_public_ip "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("\n    172.16.240.185,\n    172.16.242.218,\n    172.16.240.44\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n")])])]),t("p",[a._v("At the end of the output you should see 3 IP addresses which\nshould be accessible by ssh using your public key "),t("code",[a._v("~/.ssh/id_rsa.pub")]),a._v(".")]),a._v(" "),t("p",[t("img",{attrs:{src:"https://www.openstack.org/themes/openstack/images/openstack-logo/2016R/OpenStack-Logo-Horizontal.SVG",alt:"Openstack",title:"Openstack"}})])])},[],!1,null,null,null);s.default=r.exports}}]);